function measurelut% Measure LUT of a monitor using the Minolta LS-110 luminance meter% It will measure luminances of individual guns as well as of gray% Most reliable with Minolta set to "Fast" response%% Send comments and bug reports to: f.w.cornelissen@med.rug.nl%% History%%	24-06-2000	FWC	Created it based on c-code version%	26-09-2000	FWC added comments, added dialog for output file% 	20-01-2002	fwc	changed for use with new version of minolta toolboxclear all;programname='Measure Monitor LUT';showreadings=1; % show readings on screen during calibrationmodifierkeyname='apple';quitkeyname='esc';modifierkey=KbName(modifierkeyname);quitkey=KbName(quitkeyname);guns=4;gunname=['Red  '; 'Green'; 'Blue '; 'Gray '];fprintf('Welcome to the ''%s'' program.\n\n', programname);par=[];par=setdefaultparameters(par);i=0;while 1	par=getparams(par, i);	% check values	[myerr,par]=checkfilenames(par);	if myerr==0		break;	end	i=i+1;	if i>5 % max of five attempts		return;	endend% change port if we're simulatingif par.simulate==1 	par.port=0;endfprintf('Looking for a luminance meter....\n');minolta=initLuminanceMeter(par.port);if minolta.port < 0		fprintf('Luminance meter not found.\n');	return;endfprintf('Starting measurements.\n');quittxt=sprintf('''%s''+''%s'' to quit', modifierkeyname, quitkeyname);fprintf('\n\nPress %s.\n\n', quittxt);whichScreen=0; % 0 for main screenpixelsize=32;isColor=1;width=640;height=480;refresh=120;pixelsize=32;isColor=1;width=832;height=624;refresh=75;[window, winrect]=setupwindow(whichScreen, width, height, refresh, pixelsize,isColor);white=WhiteIndex(window);black=BlackIndex(window);% dit moet nog omgezet worden naar vinden van dac waarde op basis van luminantiebits=SCREEN(window,'Preference','ClutDacSize');maxdac=2^bits-1;if par.backdac==-1	par.backdac=round(maxdac/2);end%fprintf( '\nBits: %d, highdac: %d, backdac: %d\n', bits, maxdac, par.backdac );backcol=[par.backdac par.backdac par.backdac];size=round(par.testrectsize/100*RectWidth(winrect));testrect=[0 0 size size ];testrect = CenterRect(testrect, winrect);screen(window, 'waitblanking');SCREEN(window,'FillRect', backcol);SCREEN(window,'FillRect',black, testrect);SCREEN(window,'FillRect',white, testrect);SCREEN(window,'TextFont','Helvetica');SCREEN(window,'TextSize',par.fontsize);txt='Aim Minolta at central square';SCREEN(window,'DrawText',txt,50,50,white);txt=['Press a key to continue, ' quittxt];SCREEN(window,'DrawText',txt,50,50+par.fontsize*1.5,white);%SCREEN(window,'DrawText',quittxt,50,50+2*par.fontsize*1.5,white);eraserect=winrect;eraserect(4)=eraserect(4)/8;while 1	[keyIsDown,secs,keyCode] = KbCheck;	if keyIsDown		break;	endendhidecursor;tstart=getsecs;while 1	timeleft=par.runawaytime-(getsecs-tstart);		txt=sprintf('You have %.1f s to leave the room (%s) ', timeleft, quittxt);	SCREEN(window,'FillRect', backcol, eraserect);	SCREEN(window,'DrawText',txt,50,50,white);	[keyIsDown,secs,keyCode] = KbCheck;	if keyCode(modifierkey) & keyCode(quitkey)		break;	end	if timeleft < par.runawaystep		waitsecs(timeleft);		break;	end	waitsecs(par.runawaystep);endSCREEN(window,'FillRect', backcol);waitsecs(par.settletime);[backlum, m,t]=getLuminance(minolta);if backlum<0	SCREEN('CloseAll');	closeLuminanceMeter(minolta);	fprintf('Could not get a reading for background luminance.\n');	return;end% create lut and measure luminanceslut=ones(guns,maxdac+1)*-1;i=0;for g=1:guns	for dac=0:par.dacstep:maxdac		switch g			case 1,				colour=[dac 0 0];			case 2,				colour=[0 dac 0];			case 3,				colour=[0 0 dac];			case 4,				colour=[dac dac dac]; % grey			otherwise,				fprintf('Unknown gun...\n');				return;		end		screen(window, 'waitblanking');		SCREEN(window,'FillRect',colour, testrect);		waitsecs(par.settletime);		[lum, m,t]=getLuminance(minolta);		lut(g,dac+1)=lum;		if showreadings==1			SCREEN(window,'FillRect', backcol, eraserect);			txt=sprintf('%s %4d, lum: %.3f', deblank(gunname(g,:)), dac, lum);			SCREEN(window,'DrawText',txt,50,50,white);		end		%fprintf( '\nGun#%d: dac: %d, lum: %f', g, dac, lum );			i=i+1;				if mod(i, par.savestep)==0			saveLUTfile( par.outfilename, lut, par.dacstep);		end				[keyIsDown,secs,keyCode] = KbCheck;		if keyCode(modifierkey) & keyCode(quitkey)			break;		end	endendsaveLUTfile( par.outfilename, lut, par.dacstep);fprintf('Saved LUT to ''%s''.\n', par.outfilename );% save a report filefp=fopen( par.reportfilename, 'w');fprintf(fp, 'Report for LUT file: ''%s''.\n', par.outfilename);fprintf(fp, 'This file: ''%s''.\n', par.reportfilename);fprintf(fp, 'Produced by ''%s'' program.\n', programname);fprintf(fp, 'Measurement performed on: %s.\n', datestr(now,0));fprintf(fp, 'Screen: pixelsize: %d w: %d h: %d refresh: %f Hz\n', pixelsize, width, height, refresh);fprintf(fp, 'Clut Dac Size: %d, highest dac value: %d\n', bits, maxdac );fprintf(fp, 'Background: dac value: %d, lum: %f\n', par.backdac, backlum);fprintf(fp, 'Dac stepsize: %d\n', par.dacstep);fprintf(fp, 'Measurement rect size: %.1f %% of screen (%d x %d pixels)\n', par.testrectsize, size, size);PrintComputerDescription(fp);fprintf(fp, 'End of report\n');fclose(fp);filetype(par.reportfilename,'TEXT','XCEL');fprintf('Saved report to ''%s''.\n', par.reportfilename );SCREEN('CloseAll');closeLuminanceMeter(minolta);FlushEvents('keyDown');fprintf('\nBye!\n\n');%------------------function par=setdefaultparameters(par)par.simulate=0; % 0 to use meter, 1 to simulatepar.port=-1; % serial port to use (-1 to select)par.outfile='dummy';par.outdir='lutfiles';par.fontsize=24;par.backlum=25.0; % which background luminance to usepar.backdac=-1; % set to middle graypar.testrectsize=10;  % percentage of horizontal screensizepar.dacstep=15;par.settletime=.5;par.runawaytime=5.0;par.runawaystep=1.0;par.savestep=15; % save after how many measurements?%---------------function saveLUTfile( filename, lut, step)% save lum values to file[n,m]=size(lut);if n>1 & m>1	fp=fopen( filename, 'w');	fprintf(fp, 'DAC\tRED\tGREEN\tBLUE\tWHITE\n');	for c=1:step:m		fprintf(fp,'%d', c-1);		for g=1:n			fprintf(fp,'\t%f', lut(g,c));		end		fprintf(fp,'\n');	end	fclose(fp);	filetype(filename,'TEXT','XCEL');end%----------------------------------------------------function data=getparams(data,n)if n==0	dlgtext='Enter parameters for this experiment';else	dlgtext='Sorry, one of the parameters contained an error';end% First, create table of parameter names, default values and promptsParameters = { 															...'outfile',		'dummy',	'Name of file to which to write results';	...'outdir',		'output',	'Folder for result files';					...'backdac'		'-1',		'Background dac setting (-1 for middle gray)';	...'testrectsize'	'10.0',		'Size of test rect (as % of screen)';	...'runawaytime', '1.0',		'Time to leave the room'; ...'settletime', '0.5',		'Time to let screen settle'; ...'dacstep', 		'15',		'DAC Step size'; ...'port'			'-1',		'Serial port to use (-1 to select)';	...'simulate'		'1',		'Simulate meter (1=yes, 0=no)';	...};% set defaultsfor i = 1:size(Parameters,1)	if ~isempty(str2num(Parameters{i,2}))		eval([ 'Parameters{' num2str(i) ',2}=num2str(data.' Parameters{i,1} ');']); % for string entries	else		eval([ 'Parameters{' num2str(i) ',2}=data.' Parameters{i,1} ';']); % for number entries	endend% pop up a window to get parameter values.if 1		ParamInputs = inputdlg(Parameters(:,3), dlgtext, 1, Parameters(:,2), 'on');	[Parameters{:,2}] = deal(ParamInputs{:});end% Now assign each parameter in the table to its valuefor i = 1:size(Parameters,1)	if isempty(str2num(Parameters{i,2}))		eval(['data.' Parameters{i,1} '=''' Parameters{i,2} ''';']); % for string entries	else										eval(['data.' Parameters{i,1} '=[' Parameters{i,2} '];']);   % for number entries	endend%-------------------------------------------% setupwindowfunction [w, rect]=setupwindow(whichScreen, width, height, hz, pixelSize,isColor)% open a window of particular size and refresh rate% remember some old settingsres=NearestResolution(whichScreen,width, height, hz, pixelSize);oldRes=SCREEN(whichScreen,'Resolution');[w,rect]=SCREEN(whichScreen,'OpenWindow',0,[],res);%open screenpixelSizes=SCREEN(whichScreen,'PixelSizes');if max(pixelSizes)<pixelSize	fprintf('Sorry, I need a screen that supports %d-bit pixelSize.\n', pixelSize);	return;end[oldPixelSize,oldIsColor,pages]=SCREEN(w,'PixelSize',pixelSize,isColor);oldBoolean=SCREEN(w,'Preference','SetClutDriverWaitsForBlanking',0);white=WhiteIndex(w);black=BlackIndex(w);gray=(white+black)/2;SCREEN(w,'FillRect',gray);%--------------------------------------------------------------------% checkfilenamesfunction [myerr,par]=checkfilenames(par)myerr=1;outextension='.cal';reportextension='.txt';% Get output file name.outfile=1;i=1;			if strcmp(par.outfile,'test')==1	par.outfile=sprintf('%s%05d', par.outfile, round(rand*100000)-1 ); % add random number to filenameendpar.outfilename=[filesep par.outdir filesep par.outfile outextension];outfile=fopen(par.outfilename,'r');if outfile>0	if 1~=strcmp(par.outfile,'dummy') % allow this filename to be overwritten		fprintf('Output file ''%s'' already exists.\n', par.outfilename );		fclose(outfile);		return;	endendpar.reportfilename=[filesep par.outdir filesep par.outfile '_' 'report' outextension];myerr=0;