function device =initLuminanceMeter(whichport)% initialize settings and serial port for use with Minolta LS-110 luminance meter% whichport: set to -1 to select from available serial ports.% current preset options for 'whichport' are: 1=modem port, 2= printerport, 3=2nd Keyspan port% Part of Minolta toolbox% Send comments and bug reports to: f.w.cornelissen@med.rug.nl% history% somewhere in 1999	fwc created first version based on C-code% 20-01-2002		new version eliminating use of globals, we now use a structure to store all relevant info%					using waitLuminance to test functioning of luminanceMeterdevice=[];device.maxattempts=10;  	% how many times should we try to get a proper reading from the device?device.maxwaittime=30;		% how much time to wait for a reading from the luminance meterdevice.time=2.0;			% minimal time between measurement attempts, less then ~2 s does not seem to work very well, at least not with our meterdevice.printattempts=1;device.showmessage=0;device.minsim=0.01;device.maxsim=100.0;device.high = 1;			% value used to set DTR high (1)device.low = 0;				% value used to set DTR low (0) (triggers Minolta to perform a reading)device.dtrlowtime=20/1000.0;   	% time during which DTR signal is set low to prompt Minolta to send a new readingdevice.dtrhightime=0;		% time DTR signal is set high (not used)% serial port settings: baud4800 + data7 + stop20 + evenParitydevice.params.baudRate=4800;device.params.dataBits=7;device.params.stopBits=2;device.params.parity='even';device.params.DTR=device.high;		% set DTR high, later we lower it briefly to get a readingdevice.port=-1;switch whichport	case 0,		device.port=0;		device.portname='Simulation';	case 1,		device.port=SERIAL('Open','.AIn', '.AOut',device.params.baudRate); % modem port		device.portname='modem port';	case 2,		device.port=SERIAL('Open','.BIn', '.BOut',device.params.baudRate); % printer port		device.portname='printer port';	case 3,				device.port=SERIAL('Open','.keyUSB02in', '.keyUSB02out',device.params.baudRate); % .keyUSB02in .keyUSB02out, probably obsolete with newer versions of Keyspan software				device.portname='Keyspan USB port #2';	otherwise,		[myport]=selectSerialPort;		if 1~=strcmp(myport.name,'')			if 1==strcmp(myport.name,'Simulation mode')				device.port=0;				device.portname='Simulation mode';			else				device.port=SERIAL('Open', myport.inputDriverName, myport.outputDriverName, device.params.baudRate);				device.portname=myport.name;			end		endendif device.port < 0	return;endif device.port >0 % do not if we're simulating	% change port parameters and store old ones	device.oldparams=SERIAL('Params', device.port);	SERIAL('Params',device.port, device.params);end% try to get a first reading to check if luminance meter is working properly.waitsecs(device.time);[lum, message, time]=getLuminance(device);if lum==-1	fprintf('Could not get a reading from the luminance meter.\n');	closeluminanceMeter(device);	device.port=-1;	return;end